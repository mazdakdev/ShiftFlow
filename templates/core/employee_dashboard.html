{% extends 'base.html' %}
{% block title %}داشبورد من - شیفت‌فلو{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">

  <!-- Welcome Header -->
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-gray-900 mb-2">خوش آمدید, {{ employee.name }}!</h1>
    <p class="text-lg text-gray-600">برنامه شیفتی و زمانی شما:</p>
  </div>

  <!-- Current Shift -->
  {% if current_shift %}
  <div class="bg-gradient-to-r from-pomodoro-green to-pomodoro-blue rounded-2xl p-8 mb-8 text-white text-center">
    <div class="mb-4">
      <svg class="w-16 h-16 mx-auto opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
    </div>
    <h2 class="text-3xl font-bold mb-2">شما اکنون در یک شیفت هستید!</h2>
    <p class="text-xl mb-4">{{ current_shift.name }}</p>
    <div class="text-lg opacity-90">
      <span class="font-semibold">{{ current_shift.start_time|time:"H:i" }}</span> -
      <span class="font-semibold">{{ current_shift.end_time|time:"H:i" }}</span>
    </div>
    <div class="mt-6" id="countdown">
      <p class="text-sm opacity-75 mb-2">تا پایان شیفت:</p>
      <div class="text-2xl font-mono font-bold" id="timer">Loading...</div>
    </div>
  </div>
  {% else %}
  <div class="bg-gray-100 rounded-2xl p-8 mb-8 text-center">
    <div class="mb-4">
      <svg class="w-16 h-16 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
    </div>
    <h2 class="text-2xl font-bold text-gray-700 mb-2">شیفتی فعال نیست</h2>
    <p class="text-gray-600">شیفت برنامه‌ریزی شده‌ای ندارید</p>
  </div>
  {% endif %}

  <!-- Next Shift -->
  {% if next_shift %}
  <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
    <h3 class="text-2xl font-bold text-gray-900 mb-6">Next Shift</h3>
    <div class="bg-gradient-to-r from-pomodoro-red to-pink-500 rounded-xl p-6 text-white">
      <div class="flex items-center justify-between">
        <div>
          <h4 class="text-xl font-semibold mb-2">{{ next_shift.name }}</h4>
          <p class="text-lg opacity-90">{{ next_shift.start_time|date:"l, F j" }} at {{ next_shift.start_time|time:"H:i" }}</p>
          <p class="opacity-75">Duration: {{ next_shift.duration_hours|floatformat:1 }} hours</p>
        </div>
        <div class="text-right">
          <div class="text-sm opacity-75 mb-2">تا شروع شیفت:</div>
          <div class="text-2xl font-mono font-bold" id="next-shift-timer">Loading...</div>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="bg-white rounded-2xl shadow-lg p-8 mb-8 text-center">
    <div class="mb-4">
      <svg class="w-16 h-16 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
      </svg>
    </div>
    <h3 class="text-2xl font-bold text-gray-700 mb-2">زمان آزاد</h3>
    <p class="text-gray-600">هیچ شیفتی پیش روی شما نیست</p>
  </div>
  {% endif %}

  <!-- Profile -->
  <div class="bg-white rounded-2xl shadow-lg p-8">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-2xl font-bold text-gray-900">اطلاعات پروفایل</h3>
      <a href="{% url 'core:update_employee_profile' %}" class="bg-pomodoro-red text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
        ویرایش پروفایل
      </a>
    </div>
    <div class="grid md:grid-cols-2 gap-6">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">نام</label>
        <p class="text-lg text-gray-900">{{ employee.name }}</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">ایمیل</label>
        <p class="text-lg text-gray-900">{{ employee.email }}</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">مجموع ساعات کاری</label>
        <p class="text-lg text-gray-900">{{ employee.working_hours }} ساعت</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">عضو از</label>
        <p class="text-lg text-gray-900">{{ employee.created_at|date:"F j, Y" }}</p>
      </div>
    </div>
  </div>
</div>

<script>
  {% if current_shift %}
  function updateCountdown() {
    const now = new Date();
    const endTime = new Date('{{ current_shift.end_time|date:"Y-m-d H:i:s" }}');
    const timeLeft = endTime - now;

    if (timeLeft <= 0) {
      document.getElementById('timer').innerHTML = 'Shift ended!';
      return;
    }

    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

    document.getElementById('timer').innerHTML =
      `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
  }

  setInterval(updateCountdown, 1000);
  updateCountdown();
  {% endif %}

  {% if next_shift %}
  function updateNextShiftCountdown() {
    const now = new Date();
    const startTime = new Date('{{ next_shift.start_time|date:"Y-m-d H:i:s" }}');
    const timeLeft = startTime - now;

    if (timeLeft <= 0) {
      document.getElementById('next-shift-timer').innerHTML = 'Starting now!';
      return;
    }

    const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));

    let timeString = '';
    if (days > 0) timeString = `${days}d ${hours}h ${minutes}m`;
    else if (hours > 0) timeString = `${hours}h ${minutes}m`;
    else timeString = `${minutes}m`;

    document.getElementById('next-shift-timer').innerHTML = timeString;
  }

  setInterval(updateNextShiftCountdown, 1000);
  updateNextShiftCountdown();
  {% endif %}
</script>
{% endblock %}
